<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- SEO Meta Tags -->
<meta name="description" content="I&#39;ve been googling this for weeks now and I have not figured out why it&#39;s not working. I&#39;ve already tried asking some ProgrammingHelp subs... - v/programming">
<meta name="keywords" content="programming, config, set, quot, pre, code, echo, array, href, anything">
<meta name="author" content="Redd Archive Demo">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://online-archives.github.io/redd-archiver-example/v/programming/comments/431077.html">

<!-- Open Graph Tags -->
<meta property="og:title" content="v/programming: I&#39;m sorry for asking this here: HTMLPurifier isn&#39;t purifying submitted data, but it purifies a test echo.">
<meta property="og:description" content="I&#39;ve been googling this for weeks now and I have not figured out why it&#39;s not working. I&#39;ve already tried asking some ProgrammingHelp subs... - v/programming">
<meta property="og:type" content="article">
<meta property="og:url" content="https://online-archives.github.io/redd-archiver-example/v/programming/comments/431077.html">
<meta property="og:site_name" content="Redd Archive Demo">

<!-- Twitter Card Tags -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="v/programming: I&#39;m sorry for asking this here: HTMLPurifier isn&#39;t purifying submitted data, but it purifies a test echo.">
<meta name="twitter:description" content="I&#39;ve been googling this for weeks now and I have not figured out why it&#39;s not working. I&#39;ve already tried asking some ProgrammingHelp subs... - v/programming">

    <!-- Favicon -->
<link rel="icon" href="../../../../static/favicon.ico" sizes="32x32">
    <link rel="icon" href="../../../../static/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="../../../../static/apple-touch-icon.png">
    <link rel="manifest" href="../../../../static/site.webmanifest">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "DiscussionForumPosting",
  "headline": "I'm sorry for asking this here: HTMLPurifier isn't purifying submitted data, but it purifies a test echo.",
  "author": {
    "@type": "Person",
    "name": "Codewow"
  },
  "datePublished": "2015-08-20T01:50:15Z",
  "interactionStatistic": {
    "@type": "InteractionCounter",
    "interactionType": "https://schema.org/CommentAction",
    "userInteractionCount": 1
  },
  "isPartOf": {
    "@type": "WebSite",
    "name": "v/programming Archive",
    "url": "https://online-archives.github.io/redd-archiver-example"
  },
  "text": "I've been googling this for weeks now and I have not figured out why it's not working. I've already tried asking some ProgrammingHelp subs and no one has ever replied... So here I am before I go to Reddit and dreadit. $config = HTMLPurifier_Config::createDefault(); $config->set('CSS.AllowedProperties', array()); $config->set('CSS.ForbiddenProperties', array('height,width')); $config->set('HTML.Allowed', 'u,p,b,i,span[style],p,strong,em,li,ul,ol,div[align],br,a[href],hr');..."
}
</script>
    <!-- Font preload removed - using system fonts for instant rendering -->

    <!-- Theme Toggle -->
    <input type="checkbox" id="dark-theme-toggle">

    <!-- Universal CSS Build -->
    <link rel="stylesheet" href="../../../../static/css/redd-archiver-universal.css">


    <title>v/programming: I&#39;m sorry for asking this here: HTMLPurifier isn&#39;t purifying submitted data, but it purifies a test echo.</title>
  </head>
  <body>
    <div class="site-content">
<header>
  <nav class="navbar navbar-expand-sm navbar-dark bg-primary">
    <a class="navbar-brand" href="../../../../v/programming/index.html">v/programming</a>
    <input type="checkbox" id="navbar-toggle" class="navbar-toggle">
    <label for="navbar-toggle" class="navbar-toggler" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </label>
    <div class="navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="../../../../v/programming/index.html">score</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../../../v/programming/index-comments/index.html">comments</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../../../v/programming/index-date/index.html">date</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../../../search">search</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../../../index.html">home</a>
        </li>
        <li class="nav-item">
          <label for="dark-theme-toggle" class="nav-link theme-toggle" title="Toggle dark theme"></label>
        </li>
      </ul>
    </div>
  </nav>
</header>

    <main role="main" class="container-fluid">
<div class="submission pt-3" data-id="voat_431077">
  <h3 class="title">
      I&#39;m sorry for asking this here: HTMLPurifier isn&#39;t purifying submitted data, but it purifies a test echo.
    
    
    
    
    
    
  </h3>
  <p>
    <span class="badge badge-primary" title="Score: 4">4</span>
    &nbsp;&nbsp;
    <span title="Posted: 2015-08-20 01:50:15 UTC">20 Aug 2015 01:50</span>
    by <span ><a class="user-link" href="../../../../user/Codewow/">u/Codewow</a>
</span>
    
    
    <span title=""></span>
  </p>
  <div class="card mt-3 mb-3">
    <div class="card-body">
      <div class="md"><p>I've been googling this for weeks now and I have not figured out why it's not working. I've already tried asking some ProgrammingHelp subs and no one has ever replied... So here I am before I go to Reddit and dreadit. </p>
<pre><code>$config = HTMLPurifier_Config::createDefault();
$config-&gt;set('CSS.AllowedProperties', array());
$config-&gt;set('CSS.ForbiddenProperties', array('height,width'));
$config-&gt;set('HTML.Allowed', 'u,p,b,i,span[style],p,strong,em,li,ul,ol,div[align],br,a[href],hr');
$config-&gt;set('HTML.AllowedAttributes', 'a.href,src,alt');
$config-&gt;set('HTML.ForbiddenAttributes', array('style'));
$purifier = new HTMLPurifier($config);
</code></pre>
<p>Based on this config set, it should work.</p>
<p>I echo out this on the same page without running it through $_POST:</p>
<pre><code>echo $purifier-&gt;purify('&lt;img src=&quot;&quot; width=&quot;20&quot; height=&quot;20&quot; /&gt;');
</code></pre>
<p>And it works just fine.</p>
<p>But once I submit it through $_POST to the database it doesn't do anything to it. Or well, it didn't do anything to begin with.</p>
<p>Why could this be?</p>
<p>Here's a pastebin... please pick it apart and let me know if you find anything...</p>
<p><a href="http://pastebin.com/Vqcn7QbF">http://pastebin.com/Vqcn7QbF</a></p></div>
    </div>
  </div>
</div>

<div class="comments">
  <h4>7 comments</h4>
        <details class="comment "
         id="comment-voat_1936542"
         data-depth="0"
         data-id="voat_1936542"
open>
    <summary class="comment-header">
        <span class="badge badge-warning-orange"
              title="Comment score: 0">
            0
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/WillyWillyBumBum/">u/WillyWillyBumBum</a>

            </span>
            
            
            
            <span title="Posted: 2015-08-20 03:30:09 UTC">20 Aug 2015 03:30</span>
        </span>
    </summary>
    <div class="md"><p>What do you mean &quot;submit it through <code>$_POST</code>&quot;? I don't think it supports <code>$purifier-&gt;purify($_POST)</code> if that's what you're doing. In any case, you'll have better luck on stack overflow.</p></div>
            <details class="comment "
         id="comment-voat_1936636"
         data-depth="1"
         data-id="voat_1936636"
open>
    <summary class="comment-header">
        <span class="badge badge-warning-orange"
              title="Comment score: 0">
            0
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/Codewow/">u/Codewow</a>

            </span>
                <span class="op-badge" title="Original Poster">[OP]</span>
            
            
            
            <span title="Posted: 2015-08-20 03:34:46 UTC">20 Aug 2015 03:34</span>
        </span>
    </summary>
    <div class="md"><p>So I ran the data through the purifier, then submit it to the database through this:</p>
<pre><code>$clean_html = mysqli_real_escape_string($conn, $_POST['Story']);
$sql=&quot;INSERT INTO published (Title, pageTitle, Story, Date)
VALUES ('$Title', '$Title', '$clean_html', '$Date')&quot;;
if (!mysqli_query($conn,$sql))
</code></pre>
<p>I left out the other sections of the code for space and cleanliness. I'll attempt stackoverflow next. They usually direct me to an answer the doesn't work and close my question, so I have better luck on places like this.</p></div>
            <details class="comment "
         id="comment-voat_1938607"
         data-depth="2"
         data-id="voat_1938607"
open>
    <summary class="comment-header">
        <span class="badge badge-warning-orange"
              title="Comment score: 0">
            0
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/tame/">u/tame</a>

            </span>
            
            
            
            <span title="Posted: 2015-08-20 05:18:06 UTC">20 Aug 2015 05:18</span>
        </span>
    </summary>
    <div class="md"><p>So to be clear, your full code snippet looks like this?</p>
<pre><code>$config = HTMLPurifier_Config::createDefault();
$config-&gt;set('CSS.AllowedProperties', array());
$config-&gt;set('CSS.ForbiddenProperties', array('height,width'));
$config-&gt;set('HTML.Allowed', 'u,p,b,i,span[style],p,strong,em,li,ul,ol,div[align],br,a[href],hr');
$config-&gt;set('HTML.AllowedAttributes', 'a.href,src,alt');
$config-&gt;set('HTML.ForbiddenAttributes', array('style'));
$purifier = new HTMLPurifier($config);
$_POST['Story'] = $purifier-&gt;purify($_POST['Story']);
$clean_html = mysqli_real_escape_string($conn, $_POST['Story']);
$sql=&quot;INSERT INTO published (Title, pageTitle, Story, Date)
VALUES ('$Title', '$Title', '$clean_html', '$Date')&quot;;
if (!mysqli_query($conn,$sql))
    die('Crap.');
</code></pre>
<p>For starters, I'd suggest using prepared statements and bind_param() instead of inserting escaped text directly into the SQL text. Yes, it'll work but IIRC, prepared statements are more efficient.</p>
<p>Next, I'd suggest changing your code to print $_POST['Story'] directly onto the page, and (if you want to stay with your string-interpolation approach to the SQL statement) print out the SQL as well. That should let you know whether it's a problem with inserting into the database (maybe your DB user doesn't have write access?) or with the $_POST variable.</p>
<p>Lastly I don't know if there's any real reason not to do it, but writing back to $_POST feels icky. I'd suggest using a different variable to hold the scrubbed HTML.</p></div>
            <details class="comment "
         id="comment-voat_1938727"
         data-depth="3"
         data-id="voat_1938727"
open>
    <summary class="comment-header">
        <span class="badge badge-warning-orange"
              title="Comment score: 0">
            0
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/Codewow/">u/Codewow</a>

            </span>
                <span class="op-badge" title="Original Poster">[OP]</span>
            
            
            
            <span title="Posted: 2015-08-20 05:25:51 UTC">20 Aug 2015 05:25</span>
        </span>
    </summary>
    <div class="md"><p>Nah that's not how it looks. For the full page here's a pastebin: <a href="http://pastebin.com/Vqcn7QbF">http://pastebin.com/Vqcn7QbF</a></p>
<p>What it's posting to database:</p>
<pre><code>&lt;p&gt;&lt;img alt=&quot;&quot; src=&quot;../images/article/rockband3.jpg&quot; style=&quot;height:7px; width:12px&quot; /&gt;&lt;/p&gt;
</code></pre>
<p>Which shouldn't be the case. I removed the style attributes so they shouldn't be allowed and should automatically be removed. But they aren't... Which leads me to believe HTMLPurifier isn't actually purifying the data. And every time I try to echo to the same page it is completely broken and returns: </p>
<pre><code>&lt;img alt=&quot;\&quot;\&quot;&quot; src=&quot;\&quot;../images/article/image.jpg\&quot;&quot; style=&quot;&quot; width:1222px\&quot;=&quot;&quot;&gt; 
</code></pre>
<p>Completely different from what it submits to the database.</p></div>
            <details class="comment "
         id="comment-voat_1938854"
         data-depth="4"
         data-id="voat_1938854"
open>
    <summary class="comment-header">
        <span class="badge badge-success-bright"
              title="Comment score: 1">
            1
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/tame/">u/tame</a>

            </span>
            
            
            
            <span title="Posted: 2015-08-20 05:33:51 UTC">20 Aug 2015 05:33</span>
        </span>
    </summary>
    <div class="md"><p>Ah ok, gotchya. Thanks for the full text, that makes it easier. :)</p>
<p>The problem is that you're purifying $Story into $clean_html, but then when you escape it, you're escaping the original $_POST['Story'] rather than escaping your purified $clean_html. So instead of this at line 86:</p>
<pre><code>$clean_html = $purifier-&gt;purify($Story);
$clean_html = mysqli_real_escape_string($conn, $_POST['Story']);
</code></pre>
<p>you want this:</p>
<pre><code>$Story = $purifier-&gt;purify($_POST['Story']);
$clean_html = mysqli_real_escape_string($conn, $Story);
</code></pre>
<p>Edit: Whoops, I got it swapped around too. Fixed now.</p></div>
            <details class="comment "
         id="comment-voat_1942246"
         data-depth="5"
         data-id="voat_1942246"
open>
    <summary class="comment-header">
        <span class="badge badge-warning-orange"
              title="Comment score: 0">
            0
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/Codewow/">u/Codewow</a>

            </span>
                <span class="op-badge" title="Original Poster">[OP]</span>
            
            
            
            <span title="Posted: 2015-08-20 10:27:17 UTC">20 Aug 2015 10:27</span>
        </span>
    </summary>
    <div class="md"><p>When I get home to fix this and this works I am going to cry... Such a stupid mistake that I couldn't notice... </p>
<p>Also I forgot to thank you. So thank you so much for pointing out my stupid mistake!</p></div>
            <details class="comment "
         id="comment-voat_1944276"
         data-depth="6"
         data-id="voat_1944276"
open>
    <summary class="comment-header">
        <span class="badge badge-success-bright"
              title="Comment score: 1">
            1
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/tame/">u/tame</a>

            </span>
            
            
            
            <span title="Posted: 2015-08-20 14:21:06 UTC">20 Aug 2015 14:21</span>
        </span>
    </summary>
    <div class="md"><p>Glad to help! :) It's the simplest mistakes that are always the hardest to spot.</p></div>
</details>

</details>

</details>

</details>

</details>

</details>

</details>

</div>
    </main>

<footer class="container-fluid">
  <a class="to-top mt-1 mb-1 btn btn-lg btn-primary" href="#top">top of page</a>
  <p class="small mb-0">
    last archived 28 Apr 2020
    <a href="https://github.com/19-84/redd-archiver">source code</a>
  </p>
</footer>
    </div>

  </body>
</html>