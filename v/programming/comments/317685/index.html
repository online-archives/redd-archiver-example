<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- SEO Meta Tags -->
<meta name="description" content="WTF? Does it save the font in such a way that it can overwrite memory in near blocks? the vulnerability, if exploited, could &#34;allow remote... - v/programming">
<meta name="keywords" content="programming, windows, quot, microsoft, patch, flaw, security, fonts, code, fixes">
<meta name="author" content="Redd Archive Demo">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://online-archives.github.io/redd-archiver-example/v/programming/comments/317685.html">

<!-- Open Graph Tags -->
<meta property="og:title" content="v/programming: All decisions have consequences, but how did MS break OpenType fonts in such a way that it allows creation of an elevated user?">
<meta property="og:description" content="WTF? Does it save the font in such a way that it can overwrite memory in near blocks? the vulnerability, if exploited, could &#34;allow remote... - v/programming">
<meta property="og:type" content="article">
<meta property="og:url" content="https://online-archives.github.io/redd-archiver-example/v/programming/comments/317685.html">
<meta property="og:site_name" content="Redd Archive Demo">

<!-- Twitter Card Tags -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="v/programming: All decisions have consequences, but how did MS break OpenType fonts in such a way that it allows creation of an elevated user?">
<meta name="twitter:description" content="WTF? Does it save the font in such a way that it can overwrite memory in near blocks? the vulnerability, if exploited, could &#34;allow remote... - v/programming">

    <!-- Favicon -->
<link rel="icon" href="../../../../static/favicon.ico" sizes="32x32">
    <link rel="icon" href="../../../../static/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="../../../../static/apple-touch-icon.png">
    <link rel="manifest" href="../../../../static/site.webmanifest">
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "DiscussionForumPosting",
  "headline": "All decisions have consequences, but how did MS break OpenType fonts in such a way that it allows creation of an elevated user?",
  "author": {
    "@type": "Person",
    "name": "TigrisMorte"
  },
  "datePublished": "2015-07-20T20:37:47Z",
  "interactionStatistic": {
    "@type": "InteractionCounter",
    "interactionType": "https://schema.org/CommentAction",
    "userInteractionCount": 4
  },
  "isPartOf": {
    "@type": "WebSite",
    "name": "v/programming Archive",
    "url": "https://online-archives.github.io/redd-archiver-example"
  },
  "text": "WTF? Does it save the font in such a way that it can overwrite memory in near blocks? the vulnerability, if exploited, could \"allow remote code execution if a user opens a specially crafted document or visits an untrusted webpage that contains embedded OpenType fonts.\" Microsoft issues 14 security fixes in July's Patch Tuesday Microsoft's monthly release of patches includes security fixes for dozens of vulnerabilities. Read More \"An attacker could then install programs; view, change, or delete..."
}
</script>
    <!-- Font preload removed - using system fonts for instant rendering -->

    <!-- Theme Toggle -->
    <input type="checkbox" id="dark-theme-toggle">

    <!-- Universal CSS Build -->
    <link rel="stylesheet" href="../../../../static/css/redd-archiver-universal.css">


    <title>v/programming: All decisions have consequences, but how did MS break OpenType fonts in such a way that it allows creation of an elevated user?</title>
  </head>
  <body>
    <div class="site-content">
<header>
  <nav class="navbar navbar-expand-sm navbar-dark bg-primary">
    <a class="navbar-brand" href="../../../../v/programming/index.html">v/programming</a>
    <input type="checkbox" id="navbar-toggle" class="navbar-toggle">
    <label for="navbar-toggle" class="navbar-toggler" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </label>
    <div class="navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="../../../../v/programming/index.html">score</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../../../v/programming/index-comments/index.html">comments</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../../../v/programming/index-date/index.html">date</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../../../search">search</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../../../../index.html">home</a>
        </li>
        <li class="nav-item">
          <label for="dark-theme-toggle" class="nav-link theme-toggle" title="Toggle dark theme"></label>
        </li>
      </ul>
    </div>
  </nav>
</header>

    <main role="main" class="container-fluid">
<div class="submission pt-3" data-id="voat_317685">
  <h3 class="title">
      All decisions have consequences, but how did MS break OpenType fonts in such a way that it allows creation of an elevated user?
    
    
    
    
    
    
  </h3>
  <p>
    <span class="badge badge-primary" title="Score: 22">22</span>
    &nbsp;&nbsp;
    <span title="Posted: 2015-07-20 20:37:47 UTC">20 Jul 2015 20:37</span>
    by <span ><a class="user-link" href="../../../../user/TigrisMorte/">u/TigrisMorte</a>
</span>
    
    
    <span title=""></span>
  </p>
  <div class="card mt-3 mb-3">
    <div class="card-body">
      <div class="md"><p>WTF?  Does it save the font in such a way that it can overwrite memory in near blocks?</p>
<p>the vulnerability, if exploited, could &quot;allow remote code execution if a user opens a specially crafted document or visits an untrusted webpage that contains embedded OpenType fonts.&quot;</p>
<p>Microsoft issues 14 security fixes in July's Patch Tuesday</p>
<p>Microsoft's monthly release of patches includes security fixes for dozens of vulnerabilities.</p>
<pre><code>Read More
</code></pre>
<p>&quot;An attacker could then install programs; view, change, or delete data; or create new accounts with full user rights,&quot; the advisory added.</p>
<p>In other words, a previously undisclosed flaw in the way Windows handles certain fonts can allow a hacker to take over an entire machine.</p>
<p>Users running Windows Vista, Windows 7, 8, 8.1 and Windows RT are all affected, including those running Windows Server 2008 and later.</p>
<p>The &quot;critical&quot;-rated software update lands almost a week after its scheduled Patch Tuesday where it typically issues security fixes. Microsoft said it believed the flaw was public but did not have any evidence to suggest it was being actively exploited.</p>
<p>Security researchers from Google's Project Zero and FireEye were credited with finding the flaw.</p>
<p>The patch is available over typical update methods, including Windows Update.</p>
<p>from:
<a href="http://www.zdnet.com/article/microsoft-releases-emergency-patch-for-critical-windows-flaw/?tag=nl.e589&amp;s_cid=e589&amp;ttag=e589&amp;ftag=TREc64629f">http://www.zdnet.com/article/microsoft-releases-emergency-patch-for-critical-windows-flaw/?tag=nl.e589&amp;s_cid=e589&amp;ttag=e589&amp;ftag=TREc64629f</a></p></div>
    </div>
  </div>
</div>

<div class="comments">
  <h4>13 comments</h4>
        <details class="comment "
         id="comment-voat_1208250"
         data-depth="0"
         data-id="voat_1208250"
open>
    <summary class="comment-header">
        <span class="badge badge-success-bright"
              title="Comment score: 18">
            18
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/Craftkorb/">u/Craftkorb</a>

            </span>
            
            
            
            <span title="Posted: 2015-07-20 23:02:38 UTC">20 Jul 2015 23:02</span>
        </span>
    </summary>
    <div class="md"><p>Many things run in the Kernel in Windows. I'm really sorry to say this, but honestly, that's beyond bad idea. I'm pretty sure though that the MS guys know it themselves, so no need to say further :&gt;</p>
<p>Some things which run in the Kernel: Many things of the GUI drawing, and some other services not belonging there, like parts of the MS HTTP Server IIS (Optionally). All of these don't belong there. Why were they put there in the first place? Good question. For the IIS potion, it's to increase performance. Sorry windows lovers, but looks like the Windows kernel sucks and is abysmal slow, so slow that to win the speed race against linux boxes and their user-space daemons, they had to build a Kernel module to keep up to speed. This is the reason why every security issue inside IIS is immediately beyond critical. Fun times. For other things, I guess it was decided to put there for faster development. Wild guess. Other than that I don't know, I can't think of any good reason, really.</p>
<p>So, as drawing the GUI (Graphical User Interface) is done in the Kernel, font files are also read there. This means that every issue which leads to a crash immediately leads to a critical security issue (Oh, and it makes the system really unstable). I can't find right away what kind of exact issue this was, so let me just do some guessing what kind of issues there could have been:</p>
<ul>
<li><strong>Buffer overflow</strong>: The good old buffer overflow. Meaning, you have a data structure, allocate some kind of buffer to hold data, and then try to <code>memcpy</code> more data into it than it has space. This quickly leads to a crash, which may be mitigated by carefully crafting the data.</li>
<li><strong>Missing boundary check</strong>: Maybe they didn't do proper boundary checking, so that a index given in the OpenType font was not sanity checked, and thus triggered a write out-of-bounds.</li>
</ul>
<pre><code>// Example of a buffer overflow:
char buffer[20];
strcpy(buffer, openTypeHeader-&gt;something); // BAD: No bounds check! If 'something' contains more than 19 Bytes before hitting a 0x00 Byte, this causes a buffer overflow
// Example of a missing boundary check triggering out of bounds writes
int lookup_table[256]; // Lookup table, mapping from an index to some integer. Replace 'int' with anything you like.
lookup_table[openTypeCharacter-&gt;index] = openTypeCharacter-&gt;foo; // BAD if index is wider than 8Bits: 'index' may be greater than 256, and thus trigger a out-of-bounds write
</code></pre>
<hr />
<p>To sum it up, I'm pretty sure that the developers over at Microsoft hate themselves that at some point it was decided to put these things into the Kernel. You may have heard of mitigation technologies like <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR</a>, but these don't help on windows. Why? Take a guess. Got one? Answer is: They're disabled in the Kernel, where we're running. Oh well.</p>
<h2>One final note: Never put anything into the Kernel that may be done in user-space. Create a user-space daemon, and carefully give it the needed permissions (And only those!) to do its job.</h2>
<p><em>Drops mic</em></p></div>
            <details class="comment "
         id="comment-voat_1208352"
         data-depth="1"
         data-id="voat_1208352"
open>
    <summary class="comment-header">
        <span class="badge badge-light"
              title="Comment score: 1">
            1
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/Craftkorb/">u/Craftkorb</a>

            </span>
            
            
            
            <span title="Posted: 2015-07-20 23:05:30 UTC">20 Jul 2015 23:05</span>
        </span>
    </summary>
    <div class="md"><p>Oh, I forgot. If you want to have some more fun, google animated cursors on windows. They were .. quite risky. Bonus: Websites in IE could deploy their own custom animated cursors too, elevating that bug from a Local Privilege Escalation to a Remote Privilege Escalation. Again: Don't put that stuff in the Kernel damnit!</p></div>
</details>

            <details class="comment "
         id="comment-voat_1210087"
         data-depth="1"
         data-id="voat_1210087"
open>
    <summary class="comment-header">
        <span class="badge badge-warning-orange"
              title="Comment score: 0">
            0
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/TigrisMorte/">u/TigrisMorte</a>

            </span>
                <span class="op-badge" title="Original Poster">[OP]</span>
            
            
            
            <span title="Posted: 2015-07-21 00:00:43 UTC">21 Jul 2015 00:00</span>
        </span>
    </summary>
    <div class="md"><p>Well, wow, Um, wow.  Thanks for the great explain.</p></div>
</details>

            <details class="comment "
         id="comment-voat_1214090"
         data-depth="1"
         data-id="voat_1214090"
open>
    <summary class="comment-header">
        <span class="badge badge-warning-orange"
              title="Comment score: 0">
            0
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/Juve/">u/Juve</a>

            </span>
            
            
            
            <span title="Posted: 2015-07-21 02:25:50 UTC">21 Jul 2015 02:25</span>
        </span>
    </summary>
    <div class="md"><p>surly windows use kaslr?</p></div>
            <details class="comment "
         id="comment-voat_1214170"
         data-depth="2"
         data-id="voat_1214170"
open>
    <summary class="comment-header">
        <span class="badge badge-warning-orange"
              title="Comment score: 0">
            0
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/Craftkorb/">u/Craftkorb</a>

            </span>
            
            
            
            <span title="Posted: 2015-07-21 02:29:05 UTC">21 Jul 2015 02:29</span>
        </span>
    </summary>
    <div class="md"><p><em>Afaik</em> Windows does not. Maybe windows 10 does, as this bug only affects versions prior Windows 10.</p></div>
</details>

</details>

            <details class="comment "
         id="comment-voat_1225878"
         data-depth="1"
         data-id="voat_1225878"
open>
    <summary class="comment-header">
        <span class="badge badge-success"
              title="Comment score: 4">
            4
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/Cuddlefluff/">u/Cuddlefluff</a>

            </span>
            
            
            
            <span title="Posted: 2015-07-21 13:16:40 UTC">21 Jul 2015 13:16</span>
        </span>
    </summary>
    <div class="md"><blockquote>
<p>They're disabled in the Kernel, where we're running.</p>
</blockquote>
<p>No it's not, at least not for Windows 8.</p>
<blockquote>
<p>Create a user-space daemon, and carefully give it the needed permissions </p>
</blockquote>
<p>User-space programs (regular programs) don't have access to hardware resources and a privileged instruction set; they can't call interrupts, they can't register new interrupts, they cannot send or receive via ports, and they cannot change the IRQ priority (among other things). Because that would be a disaster, and it would completely go against the whole principle of kernel rings. Text-rendering on Windows is hardware accelerated, which necessitates a device driver to do it.</p>
<p>Also, check out who actually develops OpenType (it's not Microsoft)</p></div>
            <details class="comment "
         id="comment-voat_1226695"
         data-depth="2"
         data-id="voat_1226695"
open>
    <summary class="comment-header">
        <span class="badge badge-success"
              title="Comment score: 4">
            4
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/Craftkorb/">u/Craftkorb</a>

            </span>
            
            
            
            <span title="Posted: 2015-07-21 14:14:33 UTC">21 Jul 2015 14:14</span>
        </span>
    </summary>
    <div class="md"><blockquote>
<p>User-space programs (regular programs) don't have access to hardware resources [...]</p>
</blockquote>
<p>It's &quot;interesting&quot; that some people try hard to read stuff into everything. See the IIS server. Is it so hard to let a user-space listen on port 80 TCP? No. You can further have Kernel API to delegate specific permissions to e.g. talk to USB devices, to user-space. This also works for other operating systems. It's obvious that you'd have other Kernel API to do these read/write calls. Stuff like IRQs and Interrupts is <strong>not</strong> something everything needs. Handling interrupts is the primary job of the Kernel after setting up user-space.</p>
<p>Saying &quot;Muh performance&quot; is just ridiculous to put anything into the Kernel, if it has been show by anyone else that by having a efficient Kernel you can do everything from the user-space. Does OpenType need to handle Interrupts? No. Does it need to haggle IRQs? No. What is it doing in the frigging Ring0?! There. Is. No. Excuse.</p>
<blockquote>
<p>Text-rendering on Windows is hardware accelerated, which necessitates a device driver to do it.</p>
</blockquote>
<p>The act of rendering is the job of a driver. The act of managing is not. Weirdly enough for all over OS's this works great.</p>
<blockquote>
<p>Also, check out who actually develops OpenType (it's not Microsoft)</p>
</blockquote>
<p>It doesn't matter a lot. MS puts that stuff into its Kernel, so they better proofread it. Else, shit like this happens.</p></div>
            <details class="comment "
         id="comment-voat_1227180"
         data-depth="3"
         data-id="voat_1227180"
open>
    <summary class="comment-header">
        <span class="badge badge-light"
              title="Comment score: 3">
            3
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/Cuddlefluff/">u/Cuddlefluff</a>

            </span>
            
            
            
            <span title="Posted: 2015-07-21 14:42:57 UTC">21 Jul 2015 14:42</span>
        </span>
    </summary>
    <div class="md"><p>I'm not directly disagreeing with you, I just think that your opinion is one-dimensional and some of your opinions are up for discussion.</p>
<blockquote>
<p>It's &quot;interesting&quot; that some people try hard to read stuff into everything. See the IIS server. Is it so hard to let a user-space listen on port 80 TCP? No.</p>
</blockquote>
<p>You're right, IIS doesn't need to be a device driver, it's done like that <em>purely</em> to get performance enhancements. And if you look at the numbers, IIS outperforms all other web servers that come anywhere near close IIS in terms of functionality and flexibility. Kernel drivers will perform better than user-space programs because kernel-drivers doesn't have this giant police checking every bit and byte in case you do something wrong. It's not because Windows is inherently inefficient, it's because that's the price we pay for stability and security. This is why DOS was so goddamn fast; it just didn't care. Linux kernel drivers also has a performance benefit over user-mode space, which is why stuff that doesn't strictly need to access hardware resources also are put there; like video encoding software (would you trust user-space to compress 1080p video on-the-fly for real-time communication?)</p>
<blockquote>
<p>No. Does it need to haggle IRQs? No. What is it doing in the frigging Ring0?! There. Is. No. Excuse.</p>
</blockquote>
<p>Technically, it's Ring-1 :P Linux has one kernel ring, Windows has two; one for the OS and one for device drivers.
If you ignore performance (which is why they did it), there's no other justifiable reasons for http.sys existence. I still think it's one-sided to consider that kernel drivers only ever should handle hardware, even when there can be other justifications for doing so.</p>
<blockquote>
<p>The act of rendering is the job of a driver. The act of managing is not. Weirdly enough for all over OS's this works great.</p>
</blockquote>
<p>That's your assumption, it might not have been a result from &quot;managing&quot; at all, we don't know.</p></div>
</details>

</details>

</details>

</details>

        <details class="comment "
         id="comment-voat_1216046"
         data-depth="0"
         data-id="voat_1216046"
open>
    <summary class="comment-header">
        <span class="badge badge-light"
              title="Comment score: 2">
            2
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/something_went_wrong/">u/something_went_wrong</a>

            </span>
            
            
            
            <span title="Posted: 2015-07-21 03:42:58 UTC">21 Jul 2015 03:42</span>
        </span>
    </summary>
    <div class="md"><p>I'm surprised an MS response or fix hasn't been posted yet in <a href="/v/programming">/v/programming</a>.  <a href="https://voat.co/v/programming/comments/319733">So I posted it</a>.</p></div>
</details>

        <details class="comment "
         id="comment-voat_1230565"
         data-depth="0"
         data-id="voat_1230565"
open>
    <summary class="comment-header">
        <span class="badge badge-light"
              title="Comment score: 1">
            1
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/jamesmillner/">u/jamesmillner</a>

            </span>
            
            
            
            <span title="Posted: 2015-07-21 16:56:36 UTC">21 Jul 2015 16:56</span>
        </span>
    </summary>
    <div class="md"><p>are there any examples of fonts (web fonts) that are dangerous? are there any ways to check which web fonts are being downloaded? any way to stop it happening? can fonts be stored on, say, dafont.com, which could contain these exploits? can dodgy fonts be harmless on some systems but then dangerous on others? </p>
<p>oops, sorry, this looks like too many questions for one comment. :)  but I couldn't see any useful info...</p></div>
            <details class="comment "
         id="comment-voat_1238555"
         data-depth="1"
         data-id="voat_1238555"
open>
    <summary class="comment-header">
        <span class="badge badge-light"
              title="Comment score: 1">
            1
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/ForgotMyName/">u/ForgotMyName</a>

            </span>
            
            
            
            <span title="Posted: 2015-07-21 21:20:54 UTC">21 Jul 2015 21:20</span>
        </span>
    </summary>
    <div class="md"><p><em>sigh</em>, sadly IE actually allows you to prevent sites from downloading any custom fonts whatsoever. (Specifically because of a bug very similar to this that was encountered a few years back). This is a nightmare for web devs. We have things like icon fonts, so when you don't load the font there are no icons on the whole site. Buttons that are just icons? Blank. Super fun. </p></div>
</details>

            <details class="comment "
         id="comment-voat_1243908"
         data-depth="1"
         data-id="voat_1243908"
open>
    <summary class="comment-header">
        <span class="badge badge-light"
              title="Comment score: 1">
            1
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/goofybud16/">u/goofybud16</a>

            </span>
            
            
            
            <span title="Posted: 2015-07-22 00:06:39 UTC">22 Jul 2015 00:06</span>
        </span>
    </summary>
    <div class="md"><p>As far as how it worked: The OpenType font renderer had some security issues allowing a specific font to gain System level access and then use another file as a payload.</p>
<p><a href="http://j00ru.vexillium.org/dump/recon2015.pdf">This</a> appears to be the person who discovered it. The only fix is to fix the font rendering code.</p>
<p>He used a PDF to exploit and open Calc.exe, but it would be possible to download and execute something off of the web too.</p></div>
</details>

</details>

        <details class="comment "
         id="comment-voat_1243794"
         data-depth="0"
         data-id="voat_1243794"
open>
    <summary class="comment-header">
        <span class="badge badge-warning-orange"
              title="Comment score: 0">
            0
        </span>
        <span class="byline text-muted">
            <span >
                <a class="user-link" href="../../../../user/goofybud16/">u/goofybud16</a>

            </span>
            
            
            
            <span title="Posted: 2015-07-22 00:02:50 UTC">22 Jul 2015 00:02</span>
        </span>
    </summary>
    <div class="md"><p>Actually, I found a PDF of the exploit in <a href="https://np.reddit.com/r/reverseengineering">/r/reverseengineering</a> explaining how the person found, created, and tested the exploit.</p>
<p><a href="http://j00ru.vexillium.org/dump/recon2015.pdf">http://j00ru.vexillium.org/dump/recon2015.pdf</a></p></div>
</details>

</div>
    </main>

<footer class="container-fluid">
  <a class="to-top mt-1 mb-1 btn btn-lg btn-primary" href="#top">top of page</a>
  <p class="small mb-0">
    last archived 28 Apr 2020
    <a href="https://github.com/19-84/redd-archiver">source code</a>
  </p>
</footer>
    </div>

  </body>
</html>